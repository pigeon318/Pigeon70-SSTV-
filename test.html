<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pigeon70 SSTV - Quick Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .preview {
            margin: 10px 0;
            text-align: center;
        }
        .preview img, .preview canvas {
            max-width: 320px;
            border: 1px solid #ddd;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>üê¶ Pigeon70 SSTV - Quick Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Generate Test Image</h2>
        <button id="generateTestBtn" class="btn">Generate Test Pattern</button>
        <div id="testStatus"></div>
        <div id="testPreview" class="preview"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Encode to Audio</h2>
        <button id="encodeBtn" class="btn" disabled>Encode Test Image</button>
        <div id="encodeStatus"></div>
        <div class="progress">
            <div id="encodeProgress" class="progress-bar"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Decode from Audio</h2>
        <button id="decodeBtn" class="btn" disabled>Decode Audio</button>
        <button id="debugBtn" class="btn" disabled>Debug Audio</button>
        <div id="decodeStatus"></div>
        <div class="progress">
            <div id="decodeProgress" class="progress-bar"></div>
        </div>
        <div id="decodePreview" class="preview"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Full Cycle Test</h2>
        <button id="fullTestBtn" class="btn">Run Full Test</button>
        <div id="fullTestStatus"></div>
    </div>

    <script src="sstv-encoder.js"></script>
    <script src="sstv-decoder.js"></script>
    <script>
        let encoder = new Pigeon70Encoder();
        let decoder = new Pigeon70Decoder();
        let testImageData = null;
        let encodedAudio = null;
        let decodedImageData = null;

        // Test 1: Generate test image
        document.getElementById('generateTestBtn').addEventListener('click', generateTestImage);
        
        function generateTestImage() {
            showStatus('testStatus', 'Generating test pattern...', 'info');
            
            // Create a simple test pattern
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 320;
            canvas.height = 240;
            
            // Create test pattern
            const imageData = ctx.createImageData(320, 240);
            const data = imageData.data;
            
            for (let y = 0; y < 240; y++) {
                for (let x = 0; x < 320; x++) {
                    const index = (y * 320 + x) * 4;
                    // Create a gradient pattern
                    data[index] = Math.floor((x / 320) * 255);     // R
                    data[index + 1] = Math.floor((y / 240) * 255); // G
                    data[index + 2] = Math.floor(((x + y) / 560) * 255); // B
                    data[index + 3] = 255; // A
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            testImageData = imageData;
            
            // Show preview
            document.getElementById('testPreview').innerHTML = '';
            document.getElementById('testPreview').appendChild(canvas);
            
            showStatus('testStatus', 'Test pattern generated successfully!', 'success');
            document.getElementById('encodeBtn').disabled = false;
        }

        // Test 2: Encode image
        document.getElementById('encodeBtn').addEventListener('click', encodeTestImage);
        
        async function encodeTestImage() {
            if (!testImageData) return;
            
            try {
                showStatus('encodeStatus', 'Encoding test image to SSTV audio...', 'info');
                updateProgress('encodeProgress', 0);
                
                const startTime = Date.now();
                encodedAudio = await encoder.encodeImage(testImageData);
                const encodeTime = Date.now() - startTime;
                
                updateProgress('encodeProgress', 100);
                showStatus('encodeStatus', `Encoding completed in ${encodeTime}ms. Audio length: ${(encodedAudio.length / 44100).toFixed(1)}s`, 'success');
                
                document.getElementById('decodeBtn').disabled = false;
                document.getElementById('debugBtn').disabled = false;
                
            } catch (error) {
                showStatus('encodeStatus', `Encoding failed: ${error.message}`, 'error');
            }
        }

        // Test 3: Decode audio
        document.getElementById('decodeBtn').addEventListener('click', decodeAudio);
        document.getElementById('debugBtn').addEventListener('click', debugAudio);
        
        async function decodeAudio() {
            if (!encodedAudio) return;
            
            try {
                showStatus('decodeStatus', 'Decoding SSTV audio to image...', 'info');
                updateProgress('decodeProgress', 0);
                
                // Set up progress callback
                decoder.setProgressCallback((progress) => {
                    updateProgress('decodeProgress', progress * 100);
                });
                
                const startTime = Date.now();
                decodedImageData = await decoder.decodeAudio(encodedAudio);
                const decodeTime = Date.now() - startTime;
                
                updateProgress('decodeProgress', 100);
                showStatus('decodeStatus', `Decoding completed in ${decodeTime}ms. Image reconstructed successfully!`, 'success');
                
                // Show preview
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = decodedImageData.width;
                canvas.height = decodedImageData.height;
                ctx.putImageData(decodedImageData, 0, 0);
                
                document.getElementById('decodePreview').innerHTML = '';
                document.getElementById('decodePreview').appendChild(canvas);
                
            } catch (error) {
                showStatus('decodeStatus', `Decoding failed: ${error.message}`, 'error');
            }
        }
        
        async function debugAudio() {
            if (!encodedAudio) return;
            
            try {
                showStatus('decodeStatus', 'Analyzing audio...', 'info');
                const testResult = decoder.testAudioBuffer(encodedAudio);
                
                let message = `Audio Analysis:\n`;
                message += `‚Ä¢ Duration: ${testResult.duration.toFixed(2)}s\n`;
                message += `‚Ä¢ VIS Code: ${testResult.visFound ? 'Found' : 'Not Found'}\n`;
                message += `‚Ä¢ Sync Pulses: ${testResult.syncCount}\n`;
                message += `‚Ä¢ Expected: 240 sync pulses\n\n`;
                message += `Check console for detailed analysis.`;
                
                showStatus('decodeStatus', message, testResult.visFound ? 'success' : 'error');
                
            } catch (error) {
                showStatus('decodeStatus', `Debug failed: ${error.message}`, 'error');
            }
        }

        // Test 4: Full cycle test
        document.getElementById('fullTestBtn').addEventListener('click', runFullTest);
        
        async function runFullTest() {
            try {
                showStatus('fullTestStatus', 'Running full encode/decode test...', 'info');
                
                // Step 1: Generate test image
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 320;
                canvas.height = 240;
                
                const imageData = ctx.createImageData(320, 240);
                const data = imageData.data;
                
                for (let y = 0; y < 240; y++) {
                    for (let x = 0; x < 320; x++) {
                        const index = (y * 320 + x) * 4;
                        data[index] = (x % 2) * 255;     // R - checkerboard
                        data[index + 1] = (y % 2) * 255; // G - checkerboard
                        data[index + 2] = ((x + y) % 2) * 255; // B - checkerboard
                        data[index + 3] = 255; // A
                    }
                }
                
                // Step 2: Encode
                const encodeStart = Date.now();
                const audio = await encoder.encodeImage(imageData);
                const encodeTime = Date.now() - encodeStart;
                
                // Step 3: Decode
                const decodeStart = Date.now();
                const decoded = await decoder.decodeAudio(audio);
                const decodeTime = Date.now() - decodeStart;
                
                // Step 4: Analyze results
                let pixelErrors = 0;
                for (let i = 0; i < data.length; i += 4) {
                    const origR = data[i];
                    const origG = data[i + 1];
                    const origB = data[i + 2];
                    
                    const decR = decoded.data[i];
                    const decG = decoded.data[i + 1];
                    const decB = decoded.data[i + 2];
                    
                    if (Math.abs(origR - decR) > 50 || Math.abs(origG - decG) > 50 || Math.abs(origB - decB) > 50) {
                        pixelErrors++;
                    }
                }
                
                const totalPixels = (320 * 240);
                const errorRate = (pixelErrors / totalPixels * 100).toFixed(1);
                
                let message = `Full Test Results:\n`;
                message += `‚Ä¢ Encode Time: ${encodeTime}ms\n`;
                message += `‚Ä¢ Decode Time: ${decodeTime}ms\n`;
                message += `‚Ä¢ Audio Duration: ${(audio.length / 44100).toFixed(1)}s\n`;
                message += `‚Ä¢ Pixel Errors: ${pixelErrors}/${totalPixels} (${errorRate}%)\n`;
                message += `‚Ä¢ Test Status: ${errorRate < 20 ? 'PASS' : 'FAIL'}`;
                
                showStatus('fullTestStatus', message, errorRate < 20 ? 'success' : 'error');
                
            } catch (error) {
                showStatus('fullTestStatus', `Full test failed: ${error.message}`, 'error');
            }
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message.replace(/\n/g, '<br>')}</div>`;
        }
        
        function updateProgress(elementId, percent) {
            const element = document.getElementById(elementId);
            element.style.width = percent + '%';
        }
    </script>
</body>
</html>


